'use strict';

/** @type {import('sequelize-cli').Migration} */
module.exports = {
  async up(queryInterface) {
    await queryInterface.sequelize.query(
      `
      CREATE MATERIALIZED VIEW IF NOT EXISTS PUBLIC.CONFIG_PENDANT_PRODUCT_PRICE_VIEW TABLESPACE PG_DEFAULT AS
SELECT
	CPP.ID,
	CPP.BALE_TYPE,
	CPP.DESIGN_TYPE,
	CPP.CENTER_DIA_SHAPE,
	CPP.CENTER_DIA_WT,
	CPP.CENTER_DIA_MM_SIZE,
	CPP.CENTER_DIA_COUNT,
	CPP.STYLE_NO,
	CPP.SORT_DESCRIPTION,
	CPP.LONG_DESCRIPTION,
	CPP.LABOUR_CHARGE,
	CPP.OTHER_CHARGE,
	CPP.IS_ACTIVE,
	CPP.NAME,
	CPP.SKU,
	CPP.SLUG,
	CPP.COMPANY_INFO_ID,
	PM.METAL_ID,
	PM.KARAT_ID,
	PM.METAL_WT,
	MM.METAL_RATE,
	MM.CALCULATE_RATE,
	GK.NAME AS KARAT_NAME,
	CS.VALUE AS CENTER_DIA_WT_VALUE,
	DS.NAME AS CENTER_DIA_SHAPE_NAME,
	DT.NAME AS DESIGN_TYPE_NAME,
	MS.VALUE AS MM_SIZE_VALUE,
	COALESCE(PD.TOTAL_DIA_WEIGHT, 0::DOUBLE PRECISION) AS SIDE_DIA_WEIGHT,
	COALESCE(PD.TOTAL_DIA_COUNT, 0::NUMERIC) AS SIDE_DIA_COUNT,
	CS.VALUE::DOUBLE PRECISION * CPP.CENTER_DIA_COUNT::DOUBLE PRECISION + COALESCE(PD.TOTAL_DIA_WEIGHT, 0::DOUBLE PRECISION) AS TOTAL_WEIGHT,
	CPP.CENTER_DIA_COUNT::DOUBLE PRECISION + COALESCE(
		PD.TOTAL_DIA_COUNT::DOUBLE PRECISION,
		0::DOUBLE PRECISION
	) AS TOTAL_COUNT,
	PD.ALL_DIAMONDS,
	CASE
		WHEN PM.KARAT_ID IS NULL THEN MM.METAL_RATE * PM.METAL_WT + COALESCE(CPP.LABOUR_CHARGE, 0::DOUBLE PRECISION) + COALESCE(CPP.OTHER_CHARGE, 0::DOUBLE PRECISION)
		ELSE MM.METAL_RATE / MM.CALCULATE_RATE * GK.NAME::DOUBLE PRECISION / 24::DOUBLE PRECISION * PM.METAL_WT + COALESCE(CPP.LABOUR_CHARGE, 0::DOUBLE PRECISION) + COALESCE(CPP.OTHER_CHARGE, 0::DOUBLE PRECISION)
	END AS METAL_PRICE
FROM
	CONFIG_PENDANT_PRODUCTS CPP
	LEFT JOIN CONFIG_PENDANT_METALS PM ON PM.PENDANT_ID = CPP.ID
	LEFT JOIN METAL_MASTERS MM ON MM.ID = PM.METAL_ID
	LEFT JOIN GOLD_KTS GK ON GK.ID = PM.KARAT_ID
	LEFT JOIN CARAT_SIZES CS ON CS.ID = CPP.CENTER_DIA_WT
	LEFT JOIN DIAMOND_SHAPES DS ON DS.ID = CPP.CENTER_DIA_SHAPE
	LEFT JOIN HEADS DT ON DT.ID = CPP.DESIGN_TYPE
	LEFT JOIN MM_SIZES MS ON MS.ID = CPP.CENTER_DIA_MM_SIZE
	LEFT JOIN (
		SELECT
			PD_1.PENDANT_ID,
			SUM(
				PD_1.DIA_WEIGHT * PD_1.DIA_COUNT::DOUBLE PRECISION
			) AS TOTAL_DIA_WEIGHT,
			SUM(PD_1.DIA_COUNT) AS TOTAL_DIA_COUNT,
			JSON_AGG(
				JSON_BUILD_OBJECT(
					'id',
					PD_1.ID,
					'shape',
					PD_1.DIA_SHAPE,
					'shape_name',
					DS_1.NAME,
					'mm_size',
					PD_1.DIA_MM_SIZE,
					'mm_size_value',
					MS_1.VALUE,
					'count',
					PD_1.DIA_COUNT,
					'weight',
					PD_1.DIA_WEIGHT,
					'side_dia_type',
					PD_1.SIDE_DIA_PROD_TYPE
				)
			) AS ALL_DIAMONDS
		FROM
			CONFIG_PENDANT_DIAMONDS PD_1
			LEFT JOIN DIAMOND_SHAPES DS_1 ON DS_1.ID = PD_1.DIA_SHAPE
			LEFT JOIN MM_SIZES MS_1 ON MS_1.ID = PD_1.DIA_MM_SIZE
		GROUP BY
			PD_1.PENDANT_ID
	) PD ON PD.PENDANT_ID = CPP.ID
WHERE
	CPP.IS_DELETED = '0'::"bit"
WITH
	DATA;

ALTER TABLE IF EXISTS PUBLIC.CONFIG_PENDANT_PRODUCT_PRICE_VIEW OWNER TO POSTGRES;      
      `
    )
  },

  async down(queryInterface) {
    await queryInterface.sequelize.query(
      `
      DROP MATERIALIZED VIEW IF EXISTS PUBLIC.CONFIG_PENDANT_PRODUCT_PRICE_VIEW;
      `
    );
  }
};
